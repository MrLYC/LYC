
# Zabbix 监控 Proxy 动态弹性分流方案

## Agent 上报 Proxy 地址规范

Zabbix Agent 上报的地址使用域名来表示，其中域名组织规范如下：

```
ServerActive=<Region>.<Type>.xx.com
```

即每个 *Region* 的每个类型的资源都有一个独立的上报地址，因此最大可用的 Proxy 服务器个数为 `num_of(Region) * num_of(Type)`。按云平台1.0的经验，使用 SNMP 方式来监控 VM，一个 Proxy 最多支撑 3K 个 Host，将近 230K 个监控项，云平台2.0使用 Zabbix3.0 Agent 主动上报的方式，所需监控项更少，性能更高。

当发生动态切换时，需要人为进行以下工作：

1. 将对应的域名解析到新的 Proxy IP；
2. 使用脚本在 Server 上修改对应的 Host 的 Proxy 设置。

**切换过程中会有一段时间相应的资源监控不可用（域名缓存时效，Proxy 更新时效）。**

## 动态切换演示

### 初始状态

初始状态下只有 Proxy 个数和 *Region* 数目一样，同一个 *Region* 下的不同 *Type* 解析到同一个 IP。

监控上报结构图：

```
                              +----------+
                              |          |
                 +------------>  Server  <------------+
                 |            |          |            |
                 |            +----------+            |
                 |                                    |
                 | Region1.vm.xx.com                  | Region2.vm.xx.com
                 | Region1.mysql.xx.com               | Region2.mysql.xx.com
           +-----+----+                          +----+-----+
           |          |                          |          |
        +-->  Proxy1  <--+                    +-->  Proxy2  <--+
        |  |          |  |                    |  |          |  |
        |  +----------+  |                    |  +----------+  |
        |                |                    |                |
        |                |                    |                |
+---------------------------------+   +---------------------------------+
|       |                |        |   |       |                |        |
|       |                |        |   |       |                |        |
|   +---+---+      +-----+----+   |   |   +---+---+      +-----+----+   |
|   |       |      |          |   |   |   |       |      |          |   |
|   |  VM1  |      |  MySQL1  |   |   |   |  VM2  |      |  MySQL2  |   |
|   |       |      |          |   |   |   |       |      |          |   |
|   +-------+      +----------+   |   |   +-------+      +----------+   |
|            Region1              |   |            Region2              |
|                                 |   |                                 |
+---------------------------------+   +---------------------------------+
```

### 动态切换

当 *Region1* 的 VM 的规模上去后，单个 Proxy 难以支撑，此时加入一个新的 Proxy3 为 Proxy1 分担压力，专门负责  *Region1* VM 监控数据收集。

监控上报结构图：

```
          Region1.vm.xx.com
   +----------+
   |          |               +----------+
   |  Proxy3  +--------------->          |
   |          |  +------------>  Server  <------------+
   +----^-----+  |            |          |            |
        |        |            +----------+            |
        |        |                                    |
        |        |                                    | Region2.vm.xx.com
        |        | Region1.mysql.xx.com               | Region2.mysql.xx.com
        |  +-----+----+                          +----+-----+
        |  |          |                          |          |
        |  |  Proxy1  <--+                    +-->  Proxy2  <--+
        |  |          |  |                    |  |          |  |
        |  +----------+  |                    |  +----------+  |
        |                |                    |                |
        |                |                    |                |
+---------------------------------+   +---------------------------------+
|       |                |        |   |       |                |        |
|       |                |        |   |       |                |        |
|   +---+---+      +-----+----+   |   |   +---+---+      +-----+----+   |
|   |       |      |          |   |   |   |       |      |          |   |
|   |  VM1  |      |  MySQL1  |   |   |   |  VM2  |      |  MySQL2  |   |
|   |       |      |          |   |   |   |       |      |          |   |
|   +-------+      +----------+   |   |   +-------+      +----------+   |
|            Region1              |   |            Region2              |
|                                 |   |                                 |
+---------------------------------+   +---------------------------------+
```
